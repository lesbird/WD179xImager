                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    1

                        00001   *
                        00002   * H37IMGR
                        00003   *
                        00004   * 2021.09.30 LES BIRD
                        00005   * ALSO WORKS FOR PC/Z100 5.25 DISKS (WD179X)
                        00006   *
   042.200              00007           XTEXT   HOSEQU
   042.200              00035           XTEXT   HOSDEF
   000.207              00101           XTEXT   H37DEF
   000.207              00189           XTEXT   HROM
                        00216   *
   040.000              00217   BUFSIZ  EQU     8192            DISK TRACK BUFFER SIZE
   000.014              00218   BAUD96  EQU     0CH             9,600 BAUD
   000.006              00219   BAUD19  EQU     06H             19,200 BAUD
   000.003              00220   BAUD38  EQU     03H             38,400 BAUD
   000.002              00221   BAUD56  EQU     02H             56,000 BAUD
                        00222   *
   000.003              00223   BAUDIV  EQU     03H             19200 BAUD IS DEFAULT
                        00224   *
   000.053              00225   DLY     EQU     53A
   040.037              00226   UIVEC   EQU     40037A          USER INTERRUPT VECTOR
   040.067              00227   BLKICW  EQU     40067A          INTERRUPT RETURN ADDRESS
   041.061              00228   AIO.UNI EQU     41061A          CURRENT DEVICE
                        00229   *
   000.303              00230   MI.JMP  EQU     303Q
                        00231   * Ports for H8-4
   000.340              00232   LP4     EQU     0E0H
   000.340              00233   TX4     EQU     LP4
   000.340              00234   RX4     EQU     LP4
   000.340              00235   DVL4    EQU     LP4
   000.341              00236   DVH4    EQU     LP4+1
   000.341              00237   IER4    EQU     LP4+1
   000.343              00238   LCNTL4  EQU     LP4+3
   000.344              00239   MCNTL4  EQU     LP4+4
   000.345              00240   LSTAT4  EQU     LP4+5
                        00241   *
   000.350              00242   TX5     EQU     350Q
   000.350              00243   RX5     EQU     350Q
   000.355              00244   LSTAT5  EQU     TX5+5
                        00245   *
   042.200              00246           ORG     USERFWA
                        00247   *
   042.200              00248   START   EQU     *
   042.200  021 000 040 00249           LXI     D,BUFSIZ
   042.203  041 112 050 00250           LXI     H,SECBUF
   042.206  315 341 042 00251           CALL    ZEROMEM
                        00252   * DISMOUNT ALL DRIVES
   042.211  041 061 050 00253           LXI     H,DEV1
   042.214  377 203     00254           SCALL   .DMNMS
   042.216  041 066 050 00255           LXI     H,DEV2
   042.221  377 203     00256           SCALL   .DMNMS
   042.223  041 073 050 00257           LXI     H,DEV3
   042.226  377 203     00258           SCALL   .DMNMS
                        00259   *
   042.230  315 236 042 00260           CALL    SINT
                        00261   *
   042.233  303 143 044 00262           JMP     BEGIN










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    2

                        00263   *
                        00264   * SETUP LPT PORT FOR XXXX,8N2
                        00265   *
   042.236              00266   SINT    EQU     *
                        00267   *       DI
   042.236  257         00268           XRA     A
   042.237  323 343     00269           OUT     LCNTL4
   042.241  323 341     00270           OUT     IER4
   042.243  323 344     00271           OUT     MCNTL4
   042.245  075         00272           DCR     A
   042.246  323 343     00273           OUT     LCNTL4
   042.250  076 003     00274           MVI     A,BAUDIV
   042.252  323 340     00275           OUT     DVL4
   042.254  257         00276           XRA     A
   042.255  323 341     00277           OUT     DVH4
   042.257  076 007     00278           MVI     A,07H
   042.261  323 343     00279           OUT     LCNTL4
   042.263  333 345     00280           IN      LSTAT4
   042.265  333 340     00281           IN      RX4
                        00282   *       EI
   042.267  311         00283           RET
                        00284   *
                        00285   * SEND A CHAR IN (A) TO THE LP PORT (340Q)
                        00286   *
   042.270  365         00287   CHROUT  PUSH    PSW
   042.271  333 345     00288   CHRO4   IN      LSTAT4
   042.273  346 140     00289           ANI     60H
   042.275  376 140     00290           CPI     60H
   042.277  302 271 042 00291           JNZ     CHRO4
   042.302  361         00292           POP     PSW
   042.303  323 340     00293           OUT     TX4
   042.305  311         00294           RET
                        00295   *
                        00296   * READ A CHAR FROM THE LP PORT (340Q)
                        00297   *
   042.306  333 345     00298   CHRIN   IN      LSTAT4
   042.310  037         00299           RAR
   042.311  322 306 042 00300           JNC     CHRIN
   042.314  333 340     00301           IN      RX4
   042.316  311         00302           RET
                        00303   *
   042.317  333 345     00304   CHRRDY  IN      LSTAT4
   042.321  037         00305           RAR
   042.322  311         00306           RET                     Returns NC = no char, C = char ready
                        00307   * DIRECT OUT TO CONSOLE PORT
   042.323  365         00308   OUT350  PUSH    PSW
   042.324  333 355     00309   OUT35A  IN      LSTAT5
   042.326  346 140     00310           ANI     60H
   042.330  376 140     00311           CPI     60H
   042.332  302 324 042 00312           JNZ     OUT35A
   042.335  361         00313           POP     PSW
   042.336  323 350     00314           OUT     TX5
   042.340  311         00315           RET
                        00316   *
   042.341              00317   ZEROMEM EQU     *
   042.341  257         00318           XRA     A
   042.342  167         00319           MOV     M,A










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    3

   042.343  043         00320           INX     H
   042.344  033         00321           DCX     D
   042.345  173         00322           MOV     A,E
   042.346  262         00323           ORA     D
   042.347  302 341 042 00324           JNZ     ZEROMEM
   042.352  311         00325           RET
                        00326   * FLIP LATCH TO COMMAND MODE
   042.353              00327   H37CMD  EQU     *
   042.353  076 000     00328           MVI     A,CON.CD
   042.355  323 171     00329           OUT     DK.INT
   042.357  311         00330           RET
                        00331   * FLIP LATCH TO SECTOR/TRACK MODE
   042.360              00332   H37TRK  EQU     *
   042.360  076 001     00333           MVI     A,CON.ST
   042.362  323 171     00334           OUT     DK.INT
   042.364  311         00335           RET
                        00336   *
   042.365              00337   BITS    EQU     *
   042.365  305         00338           PUSH    B
   042.366  365         00339           PUSH    PSW
   042.367  076 200     00340           MVI     A,10000000B
   042.371  004         00341           INR     B
   042.372  007         00342   BITS1   RLC
   042.373  005         00343           DCR     B
   042.374  302 372 042 00344           JNZ     BITS1
   042.377  117         00345           MOV     C,A
   043.000  361         00346           POP     PSW
   043.001  261         00347           ORA     C
   043.002  301         00348           POP     B
   043.003  311         00349           RET
                        00350   * INT4 ROUTINE
   043.004              00351   MYINT   EQU     *
   043.004  333 172     00352           IN      FD.STAT
   043.006  341         00353           POP     H
   043.007  052 067 040 00354           LHLD    BLKICW
   043.012  373         00355           EI
   043.013  351         00356           PCHL
                        00357   *
   043.014              00358   RSTBSY  EQU     *
   043.014  076 320     00359           MVI     A,FDC.FI
   043.016  323 172     00360           OUT     FD.CMD
   043.020  076 001     00361           MVI     A,1
   043.022  315 053 000 00362           CALL    DLY
   043.025  333 172     00363           IN      FD.STAT
   043.027  311         00364           RET
                        00365   * DISK DRIVE UNIT TO WD1797 BITS
   043.030              00366   UNIBITS EQU     *
   043.030  072 061 041 00367           LDA     AIO.UNI
   043.033  306 004     00368           ADI     4
   043.035  107         00369           MOV     B,A
   043.036  257         00370           XRA     A
   043.037  315 365 042 00371           CALL    BITS
   043.042  311         00372           RET
                        00373   * SELECT AIO.UNI
   043.043              00374   SELDRV  EQU     *
   043.043  365         00375           PUSH    PSW
   043.044  305         00376           PUSH    B










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    4

   043.045  315 353 042 00377           CALL    H37CMD
   043.050  315 064 043 00378           CALL    SETDENS
   043.053  373         00379           EI
   043.054  076 226     00380           MVI     A,300/2
   043.056  315 053 000 00381           CALL    DLY
   043.061  301         00382           POP     B
   043.062  361         00383           POP     PSW
   043.063  311         00384           RET
                        00385   * SET DENSITY FROM (DENS)
   043.064              00386   SETDENS EQU     *
   043.064  315 030 043 00387           CALL    UNIBITS         A=DRIVE BIT
   043.067  366 011     00388           ORI     CON.MO+CON.EI
   043.071  117         00389           MOV     C,A
   043.072  072 104 050 00390           LDA     DENS            CON.MFM OR 0
   043.075  261         00391           ORA     C
   043.076  062 103 050 00392           STA     CONCMD          DS0+CON.MO+CON.EI+CON.MFM
   043.101  323 170     00393           OUT     DK.CON
   043.103  311         00394           RET
                        00395   *
   043.104              00396   SETMFM  EQU     *
   043.104  076 004     00397           MVI     A,CON.MFM
   043.106  062 104 050 00398           STA     DENS
   043.111  303 064 043 00399           JMP     SETDENS
                        00400   *
   043.114              00401   SETFM   EQU     *
   043.114  076 000     00402           MVI     A,0
   043.116  062 104 050 00403           STA     DENS
   043.121  303 064 043 00404           JMP     SETDENS
                        00405   * SWITCH DENSITY FM<->MFM
   043.124              00406   CHGDENS EQU     *
   043.124  072 104 050 00407           LDA     DENS
   043.127  376 004     00408           CPI     CON.MFM
   043.131  312 114 043 00409           JZ      SETFM
   043.134  303 104 043 00410           JMP     SETMFM
                        00411   * DESELECT ALL DRIVES
   043.137              00412   DSLDRV  EQU     *
   043.137  365         00413           PUSH    PSW
   043.140  076 320     00414           MVI     A,FDC.FI
   043.142  323 172     00415           OUT     FD.CMD
   043.144  257         00416           XRA     A
   043.145  323 170     00417           OUT     DK.CON
   043.147  361         00418           POP     PSW
   043.150  311         00419           RET
                        00420   * 40MS DELAY
   043.151              00421   DLY40   EQU     *
   043.151  365         00422           PUSH    PSW
   043.152  305         00423           PUSH    B
   043.153  001 200 014 00424           LXI     B,3200
   043.156  013         00425   DLY40A  DCX     B
   043.157  170         00426           MOV     A,B
   043.160  261         00427           ORA     C
   043.161  302 156 043 00428           JNZ     DLY40A
   043.164  301         00429           POP     B
   043.165  361         00430           POP     PSW
   043.166  311         00431           RET
                        00432   * SET UP INTERRUPT 4 VECTOR
   043.167              00433   SUPINT  EQU     *










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    5

   043.167  041 004 043 00434           LXI     H,MYINT
   043.172  042 051 040 00435           SHLD    UIVEC+9+1
   043.175  076 303     00436           MVI     A,MI.JMP
   043.177  062 050 040 00437           STA     UIVEC+9
   043.202  311         00438           RET
                        00439   * WAIT HERE UNTIL INTERRUPT JUMPS TO BLKICW
   043.203              00440   WAITINT EQU     *
   043.203  303 203 043 00441           JMP     WAITINT
                        00442   * C=TRACK
   043.206              00443   STPIN   EQU     *
   043.206  315 043 043 00444           CALL    SELDRV
   043.211  041 226 043 00445           LXI     H,STPI2
   043.214  042 067 040 00446           SHLD    BLKICW
   043.217              00447   STPI1   EQU     *
   043.217  076 102     00448           MVI     A,FDC.STI+FDF.S20
   043.221  323 172     00449           OUT     FD.CMD
   043.223  303 203 043 00450           JMP     WAITINT
   043.226              00451   STPI2   EQU     *
   043.226  072 100 050 00452           LDA     CURTRK
   043.231  074         00453           INR     A
   043.232  062 100 050 00454           STA     CURTRK
   043.235  271         00455           CMP     C
   043.236  302 217 043 00456           JNZ     STPI1
   043.241  315 151 043 00457           CALL    DLY40
   043.244  311         00458           RET
                        00459   * C=TRACK
   043.245              00460   STPOUT  EQU     *
   043.245  315 043 043 00461           CALL    SELDRV
   043.250  072 100 050 00462           LDA     CURTRK
   043.253  267         00463           ORA     A
   043.254  312 313 043 00464           JZ      SEEK0
   043.257  041 274 043 00465           LXI     H,STPO2
   043.262  042 067 040 00466           SHLD    BLKICW
   043.265              00467   STPO1   EQU     *
   043.265  076 142     00468           MVI     A,FDC.STO+FDF.S20
   043.267  323 172     00469           OUT     FD.CMD
   043.271  303 203 043 00470           JMP     WAITINT
   043.274              00471   STPO2   EQU     *
   043.274  072 100 050 00472           LDA     CURTRK
   043.277  075         00473           DCR     A
   043.300  062 100 050 00474           STA     CURTRK
   043.303  271         00475           CMP     C
   043.304  302 265 043 00476           JNZ     STPO1
   043.307  315 151 043 00477           CALL    DLY40
   043.312  311         00478           RET
                        00479   * SEEK TO TRACK 0
   043.313              00480   SEEK0   EQU     *
   043.313  315 043 043 00481           CALL    SELDRV
   043.316  257         00482           XRA     A
   043.317  062 100 050 00483           STA     CURTRK
   043.322  041 337 043 00484           LXI     H,SEEKD
   043.325  042 067 040 00485           SHLD    BLKICW
   043.330  076 002     00486           MVI     A,FDC.RST+FDF.S20
   043.332  323 172     00487           OUT     FD.CMD
   043.334  303 203 043 00488           JMP     WAITINT
   043.337              00489   SEEKD   EQU     *
   043.337  036 012     00490           MVI     E,10            STEP IN 10 TIMES










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    6

   043.341  041 356 043 00491           LXI     H,SEEKD2
   043.344  042 067 040 00492           SHLD    BLKICW
   043.347              00493   SEEKD1  EQU     *
   043.347  076 102     00494           MVI     A,FDC.STI+FDF.S20
   043.351  323 172     00495           OUT     FD.CMD
   043.353  303 203 043 00496           JMP     WAITINT
   043.356              00497   SEEKD2  EQU     *
   043.356  035         00498           DCR     E
   043.357  302 347 043 00499           JNZ     SEEKD1
                        00500   * DOUBLE RESTORE
   043.362  041 377 043 00501           LXI     H,SEEKD3
   043.365  042 067 040 00502           SHLD    BLKICW
   043.370  076 002     00503           MVI     A,FDC.RST+FDF.S20
   043.372  323 172     00504           OUT     FD.CMD
   043.374  303 203 043 00505           JMP     WAITINT
   043.377              00506   SEEKD3  EQU     *
   043.377  315 151 043 00507           CALL    DLY40           HEAD SETTLE TIME
   044.002  346 004     00508           ANI     FDS.TK0
   044.004  300         00509           RNZ
   044.005  067         00510           STC
   044.006  311         00511           RET
                        00512   * C=TRK (STEP IN OR OUT TO REACH TARGET)
   044.007              00513   SEEKTO  EQU     *
   044.007  315 360 042 00514           CALL    H37TRK
   044.012  171         00515           MOV     A,C
   044.013  323 173     00516           OUT     FD.TRK          SET TRACK REGISTER
   044.015  072 100 050 00517           LDA     CURTRK
   044.020  221         00518           SUB     C
   044.021  310         00519           RZ                      ALREADY AT TRK C
   044.022  332 206 043 00520           JC      STPIN
   044.025  303 245 043 00521           JMP     STPOUT
                        00522   * DE=BUFFER - READ TRACK INTO BUFFER
   044.030              00523   READLP  EQU     *
   044.030  001 000 000 00524           LXI     B,0             TOTAL BYTES READ
   044.033  041 076 044 00525           LXI     H,READL2        RETURN ADDRESS
   044.036  042 067 040 00526           SHLD    BLKICW
   044.041  315 353 042 00527           CALL    H37CMD
   044.044  072 103 050 00528           LDA     CONCMD
   044.047  366 002     00529           ORI     CON.DRQ
   044.051  323 170     00530           OUT     DK.CON
                        00531   * RDS=READ SECTOR
                        00532   * DLF=15MS DELAY
                        00533   * MRF=READ TO END OF TRACK
                        00534   * SLF=SECTOR LEN SHIFT (128,256,512,1024)
                        00535   * SS1=SIDE 1 FLAG
   044.053  257         00536           XRA     A
   044.054  072 102 050 00537           LDA     SIDE            0=SIDE 1,1=SIDE 2
   044.057  027         00538           RAL                     IF A=1 THEN RAL=FDF.SS1
   044.060  366 234     00539           ORI     FDC.RDS+FDF.DLF+FDF.MRF+FDF.SLF
   044.062  323 172     00540           OUT     FD.CMD
   044.064  041 067 044 00541           LXI     H,READL1
   044.067              00542   READL1  EQU     *               LOOP UNTIL IRQ4
   044.067  166         00543           HLT                     WAIT FOR DRQ
   044.070  333 173     00544           IN      FD.DAT
   044.072  022         00545           STAX    D
   044.073  023         00546           INX     D
   044.074  003         00547           INX     B










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    7

   044.075  351         00548           PCHL                    LOOP BACK TO READL1
   044.076              00549   READL2  EQU     *
   044.076  076 010     00550           MVI     A,CON.MO
   044.100  323 170     00551           OUT     DK.CON
   044.102  151         00552           MOV     L,C
   044.103  140         00553           MOV     H,B
   044.104  042 106 050 00554           SHLD    RDCNT
   044.107  315 360 042 00555           CALL    H37TRK
   044.112  333 172     00556           IN      FD.SEC
   044.114  075         00557           DCR     A
   044.115  062 105 050 00558           STA     SPERT
   044.120  267         00559           ORA     A               SECTORS PER TRACK == 0?
   044.121  300         00560           RNZ                     NO ERRORS
   044.122  067         00561           STC                     ERROR, SET CARRY FLAG
   044.123  311         00562           RET
                        00563   * B=SEC (1-255),C=TRK (0-255)
   044.124              00564   READS   EQU     *
   044.124  315 360 042 00565           CALL    H37TRK
   044.127  170         00566           MOV     A,B
   044.130  323 172     00567           OUT     FD.SEC          SET SECTOR REGISTER
   044.132  315 007 044 00568           CALL    SEEKTO
   044.135  021 112 050 00569           LXI     D,SECBUF
   044.140  303 030 044 00570           JMP     READLP
                        00571   *
                        00572   * IMAGER COMMANDS
                        00573   * R = READ IMAGE SEND TO HOST
                        00574   * W = WRITE IMAGE FROM HOST
                        00575   * 0 = DK0
                        00576   * 1 = DK1
                        00577   * 4 = 1S40T
                        00578   * 5 = 2S40T
                        00579   * 6 = 1S80T
                        00580   * 7 = 2S80T
                        00581   * Q = QUERY DISK TYPE
                        00582   *
   044.143              00583   BEGIN   EQU     *
   044.143  315 136 031 00584           CALL    $TYPTX
   044.146  012 110 063 00585           DB      0AH,'H37IMGR 2021.09.30 BY LES BIRD',0AH
   044.206  123 117 106 00586           DB      'SOFT SECTOR DISK IMAGING PROGRAM',0AH
   044.247  104 122 111 00587           DB      'DRIVE CONFIGURATION SHOULD BE AS FOLLOWS:',0AH
   044.321  104 113 060 00588           DB      'DK0: DS 40 TRACK',0AH
   044.342  104 113 061 00589           DB      'DK1: DS 80 TRACK',8AH
   044.363  315 353 042 00590           CALL    H37CMD
   044.366  315 014 043 00591           CALL    RSTBSY
   044.371  315 167 043 00592           CALL    SUPINT
   044.374  257         00593           XRA     A               SET DRIVE UNIT TO 0
   044.375  062 061 041 00594           STA     AIO.UNI
   045.000  074         00595           INR     A
   045.001  062 111 050 00596           STA     NUMSID          SINGLE SIDE IS DEFAULT
   045.004  076 050     00597           MVI     A,40
   045.006  062 110 050 00598           STA     NUMTRK          40 TRACK IS DEFAULT
   045.011  315 043 043 00599           CALL    SELDRV
   045.014  315 313 043 00600           CALL    SEEK0           SEEK TRACK 0
   045.017              00601   BEGLP   EQU     *
   045.017  315 136 031 00602           CALL    $TYPTX
   045.022  127 101 111 00603           DB      'WAITING FOR COMMAND:',80H
   045.047  315 137 043 00604           CALL    DSLDRV










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    8

   045.052              00605   BEGLP1  EQU     *
   045.052  315 306 042 00606           CALL    CHRIN           WAIT FOR COMMAND FROM LP PORT
   045.055  376 122     00607           CPI     'R'             READ DISK IMAGE
   045.057  312 161 045 00608           JZ      CMDRDI
   045.062  376 127     00609           CPI     'W'
   045.064  312 012 046 00610           JZ      CMDWDI
   045.067  376 060     00611           CPI     '0'
   045.071  312 013 046 00612           JZ      SETDK0
   045.074  376 061     00613           CPI     '1'
   045.076  312 045 046 00614           JZ      SETDK1
   045.101  376 063     00615           CPI     '3'             IDENTIFY AS H37IMGR
   045.103  312 100 046 00616           JZ      ISH37
   045.106  376 064     00617           CPI     '4'
   045.110  312 146 046 00618           JZ      SET1S4
   045.113  376 065     00619           CPI     '5'
   045.115  312 213 046 00620           JZ      SET2S4
   045.120  376 066     00621           CPI     '6'
   045.122  312 260 046 00622           JZ      SET1S8
   045.125  376 067     00623           CPI     '7'
   045.127  312 326 046 00624           JZ      SET2S8
   045.132  376 121     00625           CPI     'Q'
   045.134  312 374 046 00626           JZ      QUERY
   045.137  376 071     00627           CPI     '9'
   045.141  312 346 047 00628           JZ      B9600
   045.144  376 050     00629           CPI     '('
   045.146  312 002 050 00630           JZ      B19200
   045.151  076 077     00631           MVI     A,'?'
   045.153  315 270 042 00632           CALL    CHROUT
   045.156  303 052 045 00633           JMP     BEGLP1
                        00634   * CMD READ DISK IMAGE
   045.161              00635   CMDRDI  EQU     *
   045.161  315 136 031 00636           CALL    $TYPTX
   045.164  122 105 101 00637           DB      'READ DISK IMAGE',8AH
   045.204  315 043 043 00638           CALL    SELDRV
   045.207  257         00639           XRA     A
   045.210  062 102 050 00640           STA     SIDE            INITIALIZE SIDE
   045.213  001 000 001 00641           LXI     B,0100H         START SECTOR 1, TRACK 0
   045.216              00642   CMDRD1  EQU     *
   045.216  315 306 042 00643           CALL    CHRIN           WAIT FOR REQUEST
   045.221  376 122     00644           CPI     'R'
   045.223  302 017 045 00645           JNZ     BEGLP           NOT 'R' SO PROBABLY ABORT
   045.226  305         00646           PUSH    B
   045.227  076 122     00647           MVI     A,'R'
   045.231  315 323 042 00648           CALL    OUT350
                        00649   *
   045.234  315 124 044 00650           CALL    READS           READ TRACK
                        00651   *
   045.237  076 010     00652           MVI     A,08H
   045.241  315 323 042 00653           CALL    OUT350
   045.244  076 123     00654           MVI     A,'S'
   045.246  315 323 042 00655           CALL    OUT350          SHOW SENDING BUFFER
                        00656   *
   045.251  315 345 045 00657           CALL    SENDT           SEND TRACK BUFFER
                        00658   *
   045.254  076 010     00659           MVI     A,08H
   045.256  315 323 042 00660           CALL    OUT350
   045.261  076 052     00661           MVI     A,'*'










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    9

   045.263  315 323 042 00662           CALL    OUT350          SHOW TRACK SENT
   045.266  301         00663           POP     B               GET SEC,TRK
   045.267  072 111 050 00664           LDA     NUMSID          1 OR 2
   045.272  075         00665           DCR     A
   045.273  312 314 045 00666           JZ      CMDRD2          SINGLE SIDED
   045.276  072 102 050 00667           LDA     SIDE            0 OR 1
   045.301  267         00668           ORA     A
   045.302  302 314 045 00669           JNZ     CMDRD2          FINISHED SIDE 2
   045.305  074         00670           INR     A
   045.306  062 102 050 00671           STA     SIDE
   045.311  303 216 045 00672           JMP     CMDRD1          READ SIDE 2
   045.314              00673   CMDRD2  EQU     *
   045.314  257         00674           XRA     A
   045.315  062 102 050 00675           STA     SIDE            SET SIDE 1
   045.320  014         00676           INR     C
   045.321  072 110 050 00677           LDA     NUMTRK
   045.324  271         00678           CMP     C
   045.325  302 216 045 00679           JNZ     CMDRD1
   045.330  076 015     00680           MVI     A,0DH
   045.332  315 323 042 00681           CALL    OUT350
   045.335  076 012     00682           MVI     A,0AH
   045.337  315 323 042 00683           CALL    OUT350
   045.342  303 017 045 00684           JMP     BEGLP
                        00685   * SEND TRACK DATA TO 340Q
   045.345              00686   SENDT   EQU     *
   045.345  052 106 050 00687           LHLD    RDCNT
   045.350  175         00688           MOV     A,L
   045.351  315 270 042 00689           CALL    CHROUT
   045.354  174         00690           MOV     A,H
   045.355  315 270 042 00691           CALL    CHROUT
   045.360  072 105 050 00692           LDA     SPERT
   045.363  315 270 042 00693           CALL    CHROUT
   045.366  021 112 050 00694           LXI     D,SECBUF
   045.371              00695   SENDT1  EQU     *
   045.371  032         00696           LDAX    D
   045.372  315 270 042 00697           CALL    CHROUT
   045.375  023         00698           INX     D
   045.376  053         00699           DCX     H
   045.377  175         00700           MOV     A,L
   046.000  264         00701           ORA     H
   046.001  302 371 045 00702           JNZ     SENDT1
   046.004  076 122     00703           MVI     A,'R'
   046.006  315 270 042 00704           CALL    CHROUT          HANDSHAKE
   046.011  311         00705           RET
                        00706   * COMMAND WRITE DISK IMAGE
   046.012              00707   CMDWDI  EQU     *
   046.012  311         00708           RET
                        00709   * COMMAND SET DRIVE 0
   046.013              00710   SETDK0  EQU     *
   046.013  365         00711           PUSH    PSW
   046.014  315 136 031 00712           CALL    $TYPTX
   046.017  123 105 124 00713           DB      'SET DK0',8AH
   046.027  257         00714           XRA     A
   046.030  062 061 041 00715           STA     AIO.UNI
   046.033  315 313 043 00716           CALL    SEEK0
   046.036  361         00717           POP     PSW
   046.037  315 270 042 00718           CALL    CHROUT          HANDSHAKE










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   10

   046.042  303 017 045 00719           JMP     BEGLP
                        00720   * COMMAND SET DRIVE 1
   046.045              00721   SETDK1  EQU     *
   046.045  365         00722           PUSH    PSW
   046.046  315 136 031 00723           CALL    $TYPTX
   046.051  123 105 124 00724           DB      'SET DK1',8AH
   046.061  076 001     00725           MVI     A,1
   046.063  062 061 041 00726           STA     AIO.UNI
   046.066  315 313 043 00727           CALL    SEEK0
   046.071  361         00728           POP     PSW
   046.072  315 270 042 00729           CALL    CHROUT
   046.075  303 017 045 00730           JMP     BEGLP
                        00731   * H37 IMAGER IDENTIFIER
   046.100              00732   ISH37   EQU     *
   046.100  315 270 042 00733           CALL    CHROUT
   046.103  315 136 031 00734           CALL    $TYPTX
   046.106  111 104 105 00735           DB      'IDENTIFY AS H37IMGR',8AH
   046.132  303 017 045 00736           JMP     BEGLP
                        00737   * SET DRIVE PARAMETERS (SIDES,TRACKS)
   046.135              00738   SETPAR  EQU     *
   046.135  170         00739           MOV     A,B
   046.136  062 111 050 00740           STA     NUMSID
   046.141  171         00741           MOV     A,C
   046.142  062 110 050 00742           STA     NUMTRK
   046.145  311         00743           RET
                        00744   * COMMAND SET SS 40 TRACK
   046.146              00745   SET1S4  EQU     *
   046.146  365         00746           PUSH    PSW
   046.147  315 136 031 00747           CALL    $TYPTX
   046.152  123 105 124 00748           DB      'SET SS 40 TRACK',8AH
   046.172  001 050 001 00749           LXI     B,0128H
   046.175  315 135 046 00750           CALL    SETPAR
   046.200  257         00751           XRA     A
   046.201  062 061 041 00752           STA     AIO.UNI
   046.204  361         00753           POP     PSW
   046.205  315 270 042 00754           CALL    CHROUT
   046.210  303 017 045 00755           JMP     BEGLP
                        00756   * COMMAND SET DS 40 TRACK
   046.213              00757   SET2S4  EQU     *
   046.213  365         00758           PUSH    PSW
   046.214  315 136 031 00759           CALL    $TYPTX
   046.217  123 105 124 00760           DB      'SET DS 40 TRACK',8AH
   046.237  001 050 002 00761           LXI     B,0228H
   046.242  315 135 046 00762           CALL    SETPAR
   046.245  257         00763           XRA     A
   046.246  062 061 041 00764           STA     AIO.UNI
   046.251  361         00765           POP     PSW
   046.252  315 270 042 00766           CALL    CHROUT
   046.255  303 017 045 00767           JMP     BEGLP
                        00768   * COMMAND SET SS 80 TRACK
   046.260              00769   SET1S8  EQU     *
   046.260  365         00770           PUSH    PSW
   046.261  315 136 031 00771           CALL    $TYPTX
   046.264  123 105 124 00772           DB      'SET SS 80 TRACK',8AH
   046.304  001 120 001 00773           LXI     B,0150H
   046.307  315 135 046 00774           CALL    SETPAR
   046.312  076 001     00775           MVI     A,1










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   11

   046.314  062 061 041 00776           STA     AIO.UNI
   046.317  361         00777           POP     PSW
   046.320  315 270 042 00778           CALL    CHROUT
   046.323  303 017 045 00779           JMP     BEGLP
                        00780   * COMMAND SET DS 80 TRACK
   046.326              00781   SET2S8  EQU     *
   046.326  365         00782           PUSH    PSW
   046.327  315 136 031 00783           CALL    $TYPTX
   046.332  123 105 124 00784           DB      'SET DS 80 TRACK',8AH
   046.352  001 120 002 00785           LXI     B,0250H
   046.355  315 135 046 00786           CALL    SETPAR
   046.360  076 001     00787           MVI     A,1
   046.362  062 061 041 00788           STA     AIO.UNI
   046.365  361         00789           POP     PSW
   046.366  315 270 042 00790           CALL    CHROUT
   046.371  303 017 045 00791           JMP     BEGLP
                        00792   * COMMAND QUERY DISK TYPE
   046.374              00793   QUERY   EQU     *
   046.374  315 270 042 00794           CALL    CHROUT
   046.377  315 136 031 00795           CALL    $TYPTX
   047.002  121 125 105 00796           DB      'QUERY DISK TYPE',8AH
   047.022  315 131 047 00797           CALL    QUERY1
   047.025  072 105 050 00798           LDA     SPERT           SECTORS PER TRACK
   047.030  315 270 042 00799           CALL    CHROUT
                        00800   * READ ADDRESS RESULTS
   047.033  072 112 050 00801           LDA     SECBUF          TRACK
   047.036  315 270 042 00802           CALL    CHROUT
   047.041  072 113 050 00803           LDA     SECBUF+1        SIDE
   047.044  315 270 042 00804           CALL    CHROUT
   047.047  072 114 050 00805           LDA     SECBUF+2        SECTOR
   047.052  315 270 042 00806           CALL    CHROUT
   047.055  072 115 050 00807           LDA     SECBUF+3        SECTOR LENGTH
   047.060  315 270 042 00808           CALL    CHROUT
   047.063  072 116 050 00809           LDA     SECBUF+4        CRC 1
   047.066  315 270 042 00810           CALL    CHROUT
   047.071  072 117 050 00811           LDA     SECBUF+5        CRC 2
   047.074  315 270 042 00812           CALL    CHROUT
                        00813   * DISK PARAMETERS
   047.077  072 111 050 00814           LDA     NUMSID          NUM SIDES
   047.102  315 270 042 00815           CALL    CHROUT
   047.105  052 106 050 00816           LHLD    RDCNT
   047.110  175         00817           MOV     A,L             RDCNT LOW BYTE
   047.111  315 270 042 00818           CALL    CHROUT
   047.114  174         00819           MOV     A,H             RDCNT HIGH BYTE
   047.115  315 270 042 00820           CALL    CHROUT
   047.120  072 104 050 00821           LDA     DENS            DENSITY CON.MFM OR 0
   047.123  315 270 042 00822           CALL    CHROUT
   047.126  303 017 045 00823           JMP     BEGLP
                        00824   *
   047.131              00825   QUERY1  EQU     *
   047.131  257         00826           XRA     A
   047.132  062 105 050 00827           STA     SPERT
   047.135  076 004     00828           MVI     A,CON.MFM       TEST MFM FIRST
   047.137  062 104 050 00829           STA     DENS
   047.142  315 043 043 00830           CALL    SELDRV
   047.145              00831   QUERYL  EQU     *
   047.145  076 002     00832           MVI     A,2










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   12

   047.147  062 111 050 00833           STA     NUMSID          DOUBLE SIDED DEFAULT
   047.152  075         00834           DCR     A
   047.153  062 102 050 00835           STA     SIDE
   047.156  001 000 001 00836           LXI     B,0100H
   047.161  315 124 044 00837           CALL    READS           TEST READ SIDE 2
   047.164  365         00838           PUSH    PSW
   047.165  257         00839           XRA     A
   047.166  062 102 050 00840           STA     SIDE
   047.171  361         00841           POP     PSW
   047.172  322 264 047 00842           JNC     QUERYS          GOOD DOUBLE SIDE READ
   047.175  076 001     00843           MVI     A,1
   047.177  062 111 050 00844           STA     NUMSID          SINGLE SIDED DISK
   047.202  001 000 001 00845           LXI     B,0100H
   047.205  315 124 044 00846           CALL    READS           READ A TRACK FILL SPERT+RDCNT
   047.210  322 264 047 00847           JNC     QUERYS          GOOD SINGLE SIDE READ
   047.213  072 104 050 00848           LDA     DENS
   047.216  376 004     00849           CPI     CON.MFM
   047.220  302 331 047 00850           JNZ     QUERY3          FAILED MFM AND FM
   047.223  315 136 031 00851           CALL    $TYPTX
   047.226  103 110 105 00852           DB      'CHECKING SINGLE DENSITY',8AH
   047.256  315 124 043 00853           CALL    CHGDENS         MIGHT BE FM
   047.261  303 145 047 00854           JMP     QUERYL
   047.264              00855   QUERYS  EQU     *
   047.264  315 353 042 00856           CALL    H37CMD
   047.267  041 331 047 00857           LXI     H,QUERY3
   047.272  042 067 040 00858           SHLD    BLKICW
   047.275  072 103 050 00859           LDA     CONCMD
   047.300  366 002     00860           ORI     CON.DRQ
   047.302  323 170     00861           OUT     DK.CON
   047.304  001 000 000 00862           LXI     B,0
   047.307  021 112 050 00863           LXI     D,SECBUF
   047.312  041 322 047 00864           LXI     H,QUERY2
   047.315  257         00865           XRA     A
   047.316  366 304     00866           ORI     FDC.RDA+FDF.DLF
   047.320  323 172     00867           OUT     FD.CMD
   047.322              00868   QUERY2  EQU     *               LOOP UNTIL IRQ4
   047.322  166         00869           HLT                     WAIT FOR DRQ
   047.323  333 173     00870           IN      FD.DAT
   047.325  022         00871           STAX    D
   047.326  023         00872           INX     D
   047.327  003         00873           INX     B
   047.330  351         00874           PCHL
   047.331              00875   QUERY3  EQU     *
   047.331  365         00876           PUSH    PSW
   047.332  076 320     00877           MVI     A,FDC.FI
   047.334  323 172     00878           OUT     FD.CMD
   047.336  333 173     00879           IN      FD.DAT
   047.340  076 010     00880           MVI     A,CON.MO
   047.342  323 170     00881           OUT     DK.CON
   047.344  361         00882           POP     PSW
   047.345  311         00883           RET
                        00884   * SET 9600 BAUD
   047.346              00885   B9600   EQU     *
   047.346  315 136 031 00886           CALL    $TYPTX
   047.351  123 105 124 00887           DB      'SET 9600 BAUD',8AH
   047.367  076 014     00888           MVI     A,0CH
   047.371  062 003 000 00889           STA     BAUDIV










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   13

   047.374  315 236 042 00890           CALL    SINT
   047.377  303 017 045 00891           JMP     BEGLP
                        00892   * SET 19200 BAUD
   050.002              00893   B19200  EQU     *
   050.002  315 136 031 00894           CALL    $TYPTX
   050.005  123 105 124 00895           DB      'SET 19200 BAUD',8AH
   050.024  076 006     00896           MVI     A,06H
   050.026  062 003 000 00897           STA     BAUDIV
   050.031  315 236 042 00898           CALL    SINT
   050.034  303 017 045 00899           JMP     BEGLP
                        00900   *
   050.037              00901   QUIT    EQU     *
   050.037  315 136 031 00902           CALL    $TYPTX
   050.042  012 107 117 00903           DB      0AH,'GOODBYE',8AH
   050.053  315 137 043 00904           CALL    DSLDRV
   050.056  257         00905           XRA     A
   050.057  377 000     00906           SCALL   .EXIT
                        00907   *
   050.061  123 131 060 00908   DEV1    DB      'SY0:',0
   050.066  123 131 061 00909   DEV2    DB      'SY1:',0
   050.073  123 131 062 00910   DEV3    DB      'SY2:',0
                        00911   *
   050.100  000         00912   CURTRK  DB      0               0-79
   050.101  000         00913   CURSEC  DB      0               1-16
   050.102  000         00914   SIDE    DB      0               0 OR 1
   050.103  000         00915   CONCMD  DB      0               LAST COMMAND SENT TO DK.CON
   050.104  004         00916   DENS    DB      CON.MFM
                        00917   *
   050.105  000         00918   SPERT   DB      0               SECTORS PER TRACK
   050.106  000 000     00919   RDCNT   DW      0               BYTES READ
   050.110  000         00920   NUMTRK  DB      0               NUM TRACKS (40 OR 80)
   050.111  000         00921   NUMSID  DB      0               NUM SIDES (1 OR 2)
                        00922   *
                        00923   * HEATH 5.25
                        00924   * FM =10 SECTORS, 256 BYTES (2560 BYTES PER TRACK)
                        00925   * MFM=16 SECTORS, 256 BYTES (4096 BYTES PER TRACK)
                        00926   * PC 5.25
                        00927   * MFM= 8 SECTORS,1024 BYTES (8192 BYTES PER TRACK)
                        00928   *
   050.112              00929   SECBUF  DS      8192            MAX FULL TRACK
                        00930   *
   110.112  000         00931           END     START


00931 Statements Assembled
38208 Bytes Free
 No Errors Detected










