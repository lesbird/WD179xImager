                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    1

                        00001   *
                        00002   * H37IMGR
                        00003   *
                        00004   * 2021.09.30 LES BIRD
                        00005   * SHOULD ALSO WORK FOR PC/Z100 5.25 DISKS (WD179X)
                        00006   *
   042.200              00007           XTEXT   HOSEQU
   042.200              00035           XTEXT   HOSDEF
   000.207              00101           XTEXT   H37DEF
   000.207              00189           XTEXT   HROM
                        00216   *
   040.000              00217   BUFSIZ  EQU     8192            DISK TRACK BUFFER SIZE
   000.014              00218   BAUD96  EQU     0CH             9,600 BAUD
   000.006              00219   BAUD19  EQU     06H             19,200 BAUD
   000.003              00220   BAUD38  EQU     03H             38,400 BAUD
   000.002              00221   BAUD56  EQU     02H             56,000 BAUD
                        00222   *
   000.014              00223   BAUDIV  EQU     0CH             9600 BAUD IS DEFAULT
                        00224   *
   000.053              00225   DLY     EQU     53A
   040.037              00226   UIVEC   EQU     40037A          USER INTERRUPT VECTOR
   040.067              00227   BLKICW  EQU     40067A          INTERRUPT RETURN ADDRESS
   041.061              00228   AIO.UNI EQU     41061A          CURRENT DEVICE
                        00229   *
   000.303              00230   MI.JMP  EQU     303Q
                        00231   * Ports for H8-4
   000.340              00232   LP4     EQU     0E0H
   000.340              00233   TX4     EQU     LP4
   000.340              00234   RX4     EQU     LP4
   000.340              00235   DVL4    EQU     LP4
   000.341              00236   DVH4    EQU     LP4+1
   000.341              00237   IER4    EQU     LP4+1
   000.343              00238   LCNTL4  EQU     LP4+3
   000.344              00239   MCNTL4  EQU     LP4+4
   000.345              00240   LSTAT4  EQU     LP4+5
                        00241   *
   000.350              00242   TX5     EQU     350Q
   000.350              00243   RX5     EQU     350Q
   000.355              00244   LSTAT5  EQU     TX5+5
                        00245   *
   042.200              00246           ORG     USERFWA
                        00247   *
   042.200              00248   START   EQU     *
   042.200  021 000 040 00249           LXI     D,BUFSIZ
   042.203  041 050 050 00250           LXI     H,SECBUF
   042.206  315 341 042 00251           CALL    ZEROMEM
                        00252   * DISMOUNT ALL DRIVES
   042.211  041 017 050 00253           LXI     H,DEV1
   042.214  377 203     00254           SCALL   .DMNMS
   042.216  041 024 050 00255           LXI     H,DEV2
   042.221  377 203     00256           SCALL   .DMNMS
   042.223  041 031 050 00257           LXI     H,DEV3
   042.226  377 203     00258           SCALL   .DMNMS
                        00259   *
   042.230  315 236 042 00260           CALL    SINT
                        00261   *
   042.233  303 143 044 00262           JMP     BEGIN










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    2

                        00263   *
                        00264   * SETUP LPT PORT FOR XXXX,8N2
                        00265   *
   042.236              00266   SINT    EQU     *
                        00267   *       DI
   042.236  257         00268           XRA     A
   042.237  323 343     00269           OUT     LCNTL4
   042.241  323 341     00270           OUT     IER4
   042.243  323 344     00271           OUT     MCNTL4
   042.245  075         00272           DCR     A
   042.246  323 343     00273           OUT     LCNTL4
   042.250  076 014     00274           MVI     A,BAUDIV
   042.252  323 340     00275           OUT     DVL4
   042.254  257         00276           XRA     A
   042.255  323 341     00277           OUT     DVH4
   042.257  076 007     00278           MVI     A,07H
   042.261  323 343     00279           OUT     LCNTL4
   042.263  333 345     00280           IN      LSTAT4
   042.265  333 340     00281           IN      RX4
                        00282   *       EI
   042.267  311         00283           RET
                        00284   *
                        00285   * SEND A CHAR IN (A) TO THE LP PORT (340Q)
                        00286   *
   042.270  365         00287   CHROUT  PUSH    PSW
   042.271  333 345     00288   CHRO4   IN      LSTAT4
   042.273  346 140     00289           ANI     60H
   042.275  376 140     00290           CPI     60H
   042.277  302 271 042 00291           JNZ     CHRO4
   042.302  361         00292           POP     PSW
   042.303  323 340     00293           OUT     TX4
   042.305  311         00294           RET
                        00295   *
                        00296   * READ A CHAR FROM THE LP PORT (340Q)
                        00297   *
   042.306  333 345     00298   CHRIN   IN      LSTAT4
   042.310  037         00299           RAR
   042.311  322 306 042 00300           JNC     CHRIN
   042.314  333 340     00301           IN      RX4
   042.316  311         00302           RET
                        00303   *
   042.317  333 345     00304   CHRRDY  IN      LSTAT4
   042.321  037         00305           RAR
   042.322  311         00306           RET                     Returns NC = no char, C = char ready
                        00307   * DIRECT OUT TO CONSOLE PORT
   042.323  365         00308   OUT350  PUSH    PSW
   042.324  333 355     00309   OUT35A  IN      LSTAT5
   042.326  346 140     00310           ANI     60H
   042.330  376 140     00311           CPI     60H
   042.332  302 324 042 00312           JNZ     OUT35A
   042.335  361         00313           POP     PSW
   042.336  323 350     00314           OUT     TX5
   042.340  311         00315           RET
                        00316   *
   042.341              00317   ZEROMEM EQU     *
   042.341  257         00318           XRA     A
   042.342  167         00319           MOV     M,A










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    3

   042.343  043         00320           INX     H
   042.344  033         00321           DCX     D
   042.345  173         00322           MOV     A,E
   042.346  262         00323           ORA     D
   042.347  302 341 042 00324           JNZ     ZEROMEM
   042.352  311         00325           RET
                        00326   * FLIP LATCH TO COMMAND MODE
   042.353              00327   H37CMD  EQU     *
   042.353  076 000     00328           MVI     A,CON.CD
   042.355  323 171     00329           OUT     DK.INT
   042.357  311         00330           RET
                        00331   * FLIP LATCH TO SECTOR/TRACK MODE
   042.360              00332   H37TRK  EQU     *
   042.360  076 001     00333           MVI     A,CON.ST
   042.362  323 171     00334           OUT     DK.INT
   042.364  311         00335           RET
                        00336   *
   042.365              00337   BITS    EQU     *
   042.365  305         00338           PUSH    B
   042.366  365         00339           PUSH    PSW
   042.367  076 200     00340           MVI     A,10000000B
   042.371  004         00341           INR     B
   042.372  007         00342   BITS1   RLC
   042.373  005         00343           DCR     B
   042.374  302 372 042 00344           JNZ     BITS1
   042.377  117         00345           MOV     C,A
   043.000  361         00346           POP     PSW
   043.001  261         00347           ORA     C
   043.002  301         00348           POP     B
   043.003  311         00349           RET
                        00350   * INT4 ROUTINE
   043.004              00351   MYINT   EQU     *
   043.004  333 172     00352           IN      FD.STAT
   043.006  341         00353           POP     H
   043.007  052 067 040 00354           LHLD    BLKICW
   043.012  373         00355           EI
   043.013  351         00356           PCHL
                        00357   *
   043.014              00358   RSTBSY  EQU     *
   043.014  076 320     00359           MVI     A,FDC.FI
   043.016  323 172     00360           OUT     FD.CMD
   043.020  076 001     00361           MVI     A,1
   043.022  315 053 000 00362           CALL    DLY
   043.025  333 172     00363           IN      FD.STAT
   043.027  311         00364           RET
                        00365   * DISK DRIVE UNIT TO WD1797 BITS
   043.030              00366   UNIBITS EQU     *
   043.030  072 061 041 00367           LDA     AIO.UNI
   043.033  306 004     00368           ADI     4
   043.035  107         00369           MOV     B,A
   043.036  257         00370           XRA     A
   043.037  315 365 042 00371           CALL    BITS
   043.042  311         00372           RET
                        00373   * SELECT AIO.UNI
   043.043              00374   SELDRV  EQU     *
   043.043  365         00375           PUSH    PSW
   043.044  305         00376           PUSH    B










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    4

   043.045  315 353 042 00377           CALL    H37CMD
   043.050  315 064 043 00378           CALL    SETDENS
   043.053  373         00379           EI
   043.054  076 226     00380           MVI     A,300/2
   043.056  315 053 000 00381           CALL    DLY
   043.061  301         00382           POP     B
   043.062  361         00383           POP     PSW
   043.063  311         00384           RET
                        00385   * SET DENSITY FROM (DENS)
   043.064              00386   SETDENS EQU     *
   043.064  315 030 043 00387           CALL    UNIBITS         A=DRIVE BIT
   043.067  366 011     00388           ORI     CON.MO+CON.EI
   043.071  117         00389           MOV     C,A
   043.072  072 042 050 00390           LDA     DENS            CON.MFM OR 0
   043.075  261         00391           ORA     C
   043.076  062 041 050 00392           STA     CONCMD          DS0+CON.MO+CON.EI+CON.MFM
   043.101  323 170     00393           OUT     DK.CON
   043.103  311         00394           RET
                        00395   *
   043.104              00396   SETMFM  EQU     *
   043.104  076 004     00397           MVI     A,CON.MFM
   043.106  062 042 050 00398           STA     DENS
   043.111  303 064 043 00399           JMP     SETDENS
                        00400   *
   043.114              00401   SETFM   EQU     *
   043.114  076 000     00402           MVI     A,0
   043.116  062 042 050 00403           STA     DENS
   043.121  303 064 043 00404           JMP     SETDENS
                        00405   * SWITCH DENSITY FM<->MFM
   043.124              00406   CHGDENS EQU     *
   043.124  072 042 050 00407           LDA     DENS
   043.127  376 004     00408           CPI     CON.MFM
   043.131  312 114 043 00409           JZ      SETFM
   043.134  303 104 043 00410           JMP     SETMFM
                        00411   * DESELECT ALL DRIVES
   043.137              00412   DSLDRV  EQU     *
   043.137  365         00413           PUSH    PSW
   043.140  076 320     00414           MVI     A,FDC.FI
   043.142  323 172     00415           OUT     FD.CMD
   043.144  257         00416           XRA     A
   043.145  323 170     00417           OUT     DK.CON
   043.147  361         00418           POP     PSW
   043.150  311         00419           RET
                        00420   * 40MS DELAY
   043.151              00421   DLY40   EQU     *
   043.151  365         00422           PUSH    PSW
   043.152  305         00423           PUSH    B
   043.153  001 200 014 00424           LXI     B,3200
   043.156  013         00425   DLY40A  DCX     B
   043.157  170         00426           MOV     A,B
   043.160  261         00427           ORA     C
   043.161  302 156 043 00428           JNZ     DLY40A
   043.164  301         00429           POP     B
   043.165  361         00430           POP     PSW
   043.166  311         00431           RET
                        00432   * SET UP INTERRUPT 4 VECTOR
   043.167              00433   SUPINT  EQU     *










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    5

   043.167  041 004 043 00434           LXI     H,MYINT
   043.172  042 051 040 00435           SHLD    UIVEC+9+1
   043.175  076 303     00436           MVI     A,MI.JMP
   043.177  062 050 040 00437           STA     UIVEC+9
   043.202  311         00438           RET
                        00439   * WAIT HERE UNTIL INTERRUPT JUMPS TO BLKICW
   043.203              00440   WAITINT EQU     *
   043.203  303 203 043 00441           JMP     WAITINT
                        00442   * C=TRACK
   043.206              00443   STPIN   EQU     *
   043.206  315 043 043 00444           CALL    SELDRV
   043.211  041 226 043 00445           LXI     H,STPI2
   043.214  042 067 040 00446           SHLD    BLKICW
   043.217              00447   STPI1   EQU     *
   043.217  076 102     00448           MVI     A,FDC.STI+FDF.S20
   043.221  323 172     00449           OUT     FD.CMD
   043.223  303 203 043 00450           JMP     WAITINT
   043.226              00451   STPI2   EQU     *
   043.226  072 036 050 00452           LDA     CURTRK
   043.231  074         00453           INR     A
   043.232  062 036 050 00454           STA     CURTRK
   043.235  271         00455           CMP     C
   043.236  302 217 043 00456           JNZ     STPI1
   043.241  315 151 043 00457           CALL    DLY40
   043.244  311         00458           RET
                        00459   * C=TRACK
   043.245              00460   STPOUT  EQU     *
   043.245  315 043 043 00461           CALL    SELDRV
   043.250  072 036 050 00462           LDA     CURTRK
   043.253  267         00463           ORA     A
   043.254  312 313 043 00464           JZ      SEEK0
   043.257  041 274 043 00465           LXI     H,STPO2
   043.262  042 067 040 00466           SHLD    BLKICW
   043.265              00467   STPO1   EQU     *
   043.265  076 142     00468           MVI     A,FDC.STO+FDF.S20
   043.267  323 172     00469           OUT     FD.CMD
   043.271  303 203 043 00470           JMP     WAITINT
   043.274              00471   STPO2   EQU     *
   043.274  072 036 050 00472           LDA     CURTRK
   043.277  075         00473           DCR     A
   043.300  062 036 050 00474           STA     CURTRK
   043.303  271         00475           CMP     C
   043.304  302 265 043 00476           JNZ     STPO1
   043.307  315 151 043 00477           CALL    DLY40
   043.312  311         00478           RET
                        00479   * SEEK TO TRACK 0
   043.313              00480   SEEK0   EQU     *
   043.313  315 043 043 00481           CALL    SELDRV
   043.316  257         00482           XRA     A
   043.317  062 036 050 00483           STA     CURTRK
   043.322  041 337 043 00484           LXI     H,SEEKD
   043.325  042 067 040 00485           SHLD    BLKICW
   043.330  076 002     00486           MVI     A,FDC.RST+FDF.S20
   043.332  323 172     00487           OUT     FD.CMD
   043.334  303 203 043 00488           JMP     WAITINT
   043.337              00489   SEEKD   EQU     *
   043.337  036 012     00490           MVI     E,10            STEP IN 10 TIMES










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    6

   043.341  041 356 043 00491           LXI     H,SEEKD2
   043.344  042 067 040 00492           SHLD    BLKICW
   043.347              00493   SEEKD1  EQU     *
   043.347  076 102     00494           MVI     A,FDC.STI+FDF.S20
   043.351  323 172     00495           OUT     FD.CMD
   043.353  303 203 043 00496           JMP     WAITINT
   043.356              00497   SEEKD2  EQU     *
   043.356  035         00498           DCR     E
   043.357  302 347 043 00499           JNZ     SEEKD1
                        00500   * DOUBLE RESTORE
   043.362  041 377 043 00501           LXI     H,SEEKD3
   043.365  042 067 040 00502           SHLD    BLKICW
   043.370  076 002     00503           MVI     A,FDC.RST+FDF.S20
   043.372  323 172     00504           OUT     FD.CMD
   043.374  303 203 043 00505           JMP     WAITINT
   043.377              00506   SEEKD3  EQU     *
   043.377  315 151 043 00507           CALL    DLY40           HEAD SETTLE TIME
   044.002  346 004     00508           ANI     FDS.TK0
   044.004  300         00509           RNZ
   044.005  067         00510           STC
   044.006  311         00511           RET
                        00512   * C=TRK (STEP IN OR OUT TO REACH TARGET)
   044.007              00513   SEEKTO  EQU     *
   044.007  315 360 042 00514           CALL    H37TRK
   044.012  171         00515           MOV     A,C
   044.013  323 173     00516           OUT     FD.TRK          SET TRACK REGISTER
   044.015  072 036 050 00517           LDA     CURTRK
   044.020  221         00518           SUB     C
   044.021  310         00519           RZ                      ALREADY AT TRK C
   044.022  332 206 043 00520           JC      STPIN
   044.025  303 245 043 00521           JMP     STPOUT
                        00522   * DE=BUFFER - READ TRACK INTO BUFFER
   044.030              00523   READLP  EQU     *
   044.030  001 000 000 00524           LXI     B,0             TOTAL BYTES READ
   044.033  041 076 044 00525           LXI     H,READL2        RETURN ADDRESS
   044.036  042 067 040 00526           SHLD    BLKICW
   044.041  315 353 042 00527           CALL    H37CMD
   044.044  072 041 050 00528           LDA     CONCMD
   044.047  366 002     00529           ORI     CON.DRQ
   044.051  323 170     00530           OUT     DK.CON
                        00531   * RDS=READ SECTOR
                        00532   * DLF=15MS DELAY
                        00533   * MRF=READ TO END OF TRACK
                        00534   * SLF=SECTOR LEN SHIFT (128,256,512,1024)
                        00535   * SS1=SIDE 1 FLAG
   044.053  257         00536           XRA     A
   044.054  072 040 050 00537           LDA     SIDE            0=SIDE 1,1=SIDE 2
   044.057  027         00538           RAL                     IF A=1 THEN RAL=FDF.SS1
   044.060  366 234     00539           ORI     FDC.RDS+FDF.DLF+FDF.MRF+FDF.SLF
   044.062  323 172     00540           OUT     FD.CMD
   044.064  041 067 044 00541           LXI     H,READL1
   044.067              00542   READL1  EQU     *               LOOP UNTIL IRQ4
   044.067  166         00543           HLT                     WAIT FOR DRQ
   044.070  333 173     00544           IN      FD.DAT
   044.072  022         00545           STAX    D
   044.073  023         00546           INX     D
   044.074  003         00547           INX     B










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    7

   044.075  351         00548           PCHL                    LOOP BACK TO READL1
   044.076              00549   READL2  EQU     *
   044.076  076 010     00550           MVI     A,CON.MO
   044.100  323 170     00551           OUT     DK.CON
   044.102  151         00552           MOV     L,C
   044.103  140         00553           MOV     H,B
   044.104  042 044 050 00554           SHLD    RDCNT
   044.107  315 360 042 00555           CALL    H37TRK
   044.112  333 172     00556           IN      FD.SEC
   044.114  075         00557           DCR     A
   044.115  062 043 050 00558           STA     SPERT
   044.120  267         00559           ORA     A               SECTORS PER TRACK == 0?
   044.121  300         00560           RNZ                     NO ERRORS
   044.122  067         00561           STC                     ERROR, SET CARRY FLAG
   044.123  311         00562           RET
                        00563   * B=SEC (1-255),C=TRK (0-255)
   044.124              00564   READS   EQU     *
   044.124  315 360 042 00565           CALL    H37TRK
   044.127  170         00566           MOV     A,B
   044.130  323 172     00567           OUT     FD.SEC          SET SECTOR REGISTER
   044.132  315 007 044 00568           CALL    SEEKTO
   044.135  021 050 050 00569           LXI     D,SECBUF
   044.140  303 030 044 00570           JMP     READLP
                        00571   *
                        00572   * IMAGER COMMANDS
                        00573   * R = READ IMAGE SEND TO HOST
                        00574   * W = WRITE IMAGE FROM HOST
                        00575   * 0 = DK0
                        00576   * 1 = DK1
                        00577   * 4 = 1S40T
                        00578   * 5 = 2S40T
                        00579   * 6 = 1S80T
                        00580   * 7 = 2S80T
                        00581   * Q = QUERY DISK TYPE
                        00582   *
   044.143              00583   BEGIN   EQU     *
   044.143  315 136 031 00584           CALL    $TYPTX
   044.146  012 110 063 00585           DB      0AH,'H37IMGR 2021.09.30 BY LES BIRD',0AH
   044.206  123 117 106 00586           DB      'SOFT SECTOR DISK IMAGING PROGRAM',0AH
   044.247  104 122 111 00587           DB      'DRIVE CONFIGURATION SHOULD BE AS FOLLOWS:',0AH
   044.321  104 113 060 00588           DB      'DK0: DS 40 TRACK',0AH
   044.342  104 113 061 00589           DB      'DK1: DS 80 TRACK',8AH
   044.363  315 353 042 00590           CALL    H37CMD
   044.366  315 014 043 00591           CALL    RSTBSY
   044.371  315 167 043 00592           CALL    SUPINT
   044.374  257         00593           XRA     A               SET DRIVE UNIT TO 0
   044.375  062 061 041 00594           STA     AIO.UNI
   045.000  074         00595           INR     A
   045.001  062 047 050 00596           STA     NUMSID          SINGLE SIDE IS DEFAULT
   045.004  076 050     00597           MVI     A,40
   045.006  062 046 050 00598           STA     NUMTRK          40 TRACK IS DEFAULT
   045.011  315 043 043 00599           CALL    SELDRV
   045.014  315 313 043 00600           CALL    SEEK0           SEEK TRACK 0
   045.017              00601   BEGLP   EQU     *
   045.017  315 136 031 00602           CALL    $TYPTX
   045.022  127 101 111 00603           DB      'WAITING FOR COMMAND:',80H
   045.047  315 137 043 00604           CALL    DSLDRV










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    8

   045.052              00605   BEGLP1  EQU     *
   045.052  315 306 042 00606           CALL    CHRIN           WAIT FOR COMMAND FROM LP PORT
   045.055  376 122     00607           CPI     'R'             READ DISK IMAGE
   045.057  312 154 045 00608           JZ      CMDRDI
   045.062  376 127     00609           CPI     'W'
   045.064  312 005 046 00610           JZ      CMDWDI
   045.067  376 060     00611           CPI     '0'
   045.071  312 006 046 00612           JZ      SETDK0
   045.074  376 061     00613           CPI     '1'
   045.076  312 040 046 00614           JZ      SETDK1
   045.101  376 064     00615           CPI     '4'
   045.103  312 104 046 00616           JZ      SET1S4
   045.106  376 065     00617           CPI     '5'
   045.110  312 151 046 00618           JZ      SET2S4
   045.113  376 066     00619           CPI     '6'
   045.115  312 216 046 00620           JZ      SET1S8
   045.120  376 067     00621           CPI     '7'
   045.122  312 264 046 00622           JZ      SET2S8
   045.125  376 121     00623           CPI     'Q'
   045.127  312 332 046 00624           JZ      QUERY
   045.132  376 071     00625           CPI     '9'
   045.134  312 304 047 00626           JZ      B9600
   045.137  376 050     00627           CPI     '('
   045.141  312 340 047 00628           JZ      B19200
   045.144  076 077     00629           MVI     A,'?'
   045.146  315 270 042 00630           CALL    CHROUT
   045.151  303 052 045 00631           JMP     BEGLP1
                        00632   * CMD READ DISK IMAGE
   045.154              00633   CMDRDI  EQU     *
   045.154  315 136 031 00634           CALL    $TYPTX
   045.157  122 105 101 00635           DB      'READ DISK IMAGE',8AH
   045.177  315 043 043 00636           CALL    SELDRV
   045.202  257         00637           XRA     A
   045.203  062 040 050 00638           STA     SIDE            INITIALIZE SIDE
   045.206  001 000 001 00639           LXI     B,0100H         START SECTOR 1, TRACK 0
   045.211              00640   CMDRD1  EQU     *
   045.211  315 306 042 00641           CALL    CHRIN           WAIT FOR REQUEST
   045.214  376 122     00642           CPI     'R'
   045.216  302 017 045 00643           JNZ     BEGLP           NOT 'R' SO PROBABLY ABORT
   045.221  305         00644           PUSH    B
   045.222  076 122     00645           MVI     A,'R'
   045.224  315 323 042 00646           CALL    OUT350
                        00647   *
   045.227  315 124 044 00648           CALL    READS           READ TRACK
                        00649   *
   045.232  076 010     00650           MVI     A,08H
   045.234  315 323 042 00651           CALL    OUT350
   045.237  076 123     00652           MVI     A,'S'
   045.241  315 323 042 00653           CALL    OUT350          SHOW SENDING BUFFER
                        00654   *
   045.244  315 340 045 00655           CALL    SENDT           SEND TRACK BUFFER
                        00656   *
   045.247  076 010     00657           MVI     A,08H
   045.251  315 323 042 00658           CALL    OUT350
   045.254  076 052     00659           MVI     A,'*'
   045.256  315 323 042 00660           CALL    OUT350          SHOW TRACK SENT
   045.261  301         00661           POP     B               GET SEC,TRK










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page    9

   045.262  072 047 050 00662           LDA     NUMSID          1 OR 2
   045.265  075         00663           DCR     A
   045.266  312 307 045 00664           JZ      CMDRD2          SINGLE SIDED
   045.271  072 040 050 00665           LDA     SIDE            0 OR 1
   045.274  267         00666           ORA     A
   045.275  302 307 045 00667           JNZ     CMDRD2          FINISHED SIDE 2
   045.300  074         00668           INR     A
   045.301  062 040 050 00669           STA     SIDE
   045.304  303 211 045 00670           JMP     CMDRD1          READ SIDE 2
   045.307              00671   CMDRD2  EQU     *
   045.307  257         00672           XRA     A
   045.310  062 040 050 00673           STA     SIDE            SET SIDE 1
   045.313  014         00674           INR     C
   045.314  072 046 050 00675           LDA     NUMTRK
   045.317  271         00676           CMP     C
   045.320  302 211 045 00677           JNZ     CMDRD1
   045.323  076 015     00678           MVI     A,0DH
   045.325  315 323 042 00679           CALL    OUT350
   045.330  076 012     00680           MVI     A,0AH
   045.332  315 323 042 00681           CALL    OUT350
   045.335  303 017 045 00682           JMP     BEGLP
                        00683   * SEND TRACK DATA TO 340Q
   045.340              00684   SENDT   EQU     *
   045.340  052 044 050 00685           LHLD    RDCNT
   045.343  175         00686           MOV     A,L
   045.344  315 270 042 00687           CALL    CHROUT
   045.347  174         00688           MOV     A,H
   045.350  315 270 042 00689           CALL    CHROUT
   045.353  072 043 050 00690           LDA     SPERT
   045.356  315 270 042 00691           CALL    CHROUT
   045.361  021 050 050 00692           LXI     D,SECBUF
   045.364              00693   SENDT1  EQU     *
   045.364  032         00694           LDAX    D
   045.365  315 270 042 00695           CALL    CHROUT
   045.370  023         00696           INX     D
   045.371  053         00697           DCX     H
   045.372  175         00698           MOV     A,L
   045.373  264         00699           ORA     H
   045.374  302 364 045 00700           JNZ     SENDT1
   045.377  076 122     00701           MVI     A,'R'
   046.001  315 270 042 00702           CALL    CHROUT          HANDSHAKE
   046.004  311         00703           RET
                        00704   * COMMAND WRITE DISK IMAGE
   046.005              00705   CMDWDI  EQU     *
   046.005  311         00706           RET
                        00707   * COMMAND SET DRIVE 0
   046.006              00708   SETDK0  EQU     *
   046.006  365         00709           PUSH    PSW
   046.007  315 136 031 00710           CALL    $TYPTX
   046.012  123 105 124 00711           DB      'SET DK0',8AH
   046.022  257         00712           XRA     A
   046.023  062 061 041 00713           STA     AIO.UNI
   046.026  315 313 043 00714           CALL    SEEK0
   046.031  361         00715           POP     PSW
   046.032  315 270 042 00716           CALL    CHROUT          HANDSHAKE
   046.035  303 017 045 00717           JMP     BEGLP
                        00718   * COMMAND SET DRIVE 1










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   10

   046.040              00719   SETDK1  EQU     *
   046.040  365         00720           PUSH    PSW
   046.041  315 136 031 00721           CALL    $TYPTX
   046.044  123 105 124 00722           DB      'SET DK1',8AH
   046.054  076 001     00723           MVI     A,1
   046.056  062 061 041 00724           STA     AIO.UNI
   046.061  315 313 043 00725           CALL    SEEK0
   046.064  361         00726           POP     PSW
   046.065  315 270 042 00727           CALL    CHROUT
   046.070  303 017 045 00728           JMP     BEGLP
                        00729   * SET DRIVE PARAMETERS (SIDES,TRACKS)
   046.073              00730   SETPAR  EQU     *
   046.073  170         00731           MOV     A,B
   046.074  062 047 050 00732           STA     NUMSID
   046.077  171         00733           MOV     A,C
   046.100  062 046 050 00734           STA     NUMTRK
   046.103  311         00735           RET
                        00736   * COMMAND SET SS 40 TRACK
   046.104              00737   SET1S4  EQU     *
   046.104  365         00738           PUSH    PSW
   046.105  315 136 031 00739           CALL    $TYPTX
   046.110  123 105 124 00740           DB      'SET SS 40 TRACK',8AH
   046.130  001 050 001 00741           LXI     B,0128H
   046.133  315 073 046 00742           CALL    SETPAR
   046.136  257         00743           XRA     A
   046.137  062 061 041 00744           STA     AIO.UNI
   046.142  361         00745           POP     PSW
   046.143  315 270 042 00746           CALL    CHROUT
   046.146  303 017 045 00747           JMP     BEGLP
                        00748   * COMMAND SET DS 40 TRACK
   046.151              00749   SET2S4  EQU     *
   046.151  365         00750           PUSH    PSW
   046.152  315 136 031 00751           CALL    $TYPTX
   046.155  123 105 124 00752           DB      'SET DS 40 TRACK',8AH
   046.175  001 050 002 00753           LXI     B,0228H
   046.200  315 073 046 00754           CALL    SETPAR
   046.203  257         00755           XRA     A
   046.204  062 061 041 00756           STA     AIO.UNI
   046.207  361         00757           POP     PSW
   046.210  315 270 042 00758           CALL    CHROUT
   046.213  303 017 045 00759           JMP     BEGLP
                        00760   * COMMAND SET SS 80 TRACK
   046.216              00761   SET1S8  EQU     *
   046.216  365         00762           PUSH    PSW
   046.217  315 136 031 00763           CALL    $TYPTX
   046.222  123 105 124 00764           DB      'SET SS 80 TRACK',8AH
   046.242  001 120 001 00765           LXI     B,0150H
   046.245  315 073 046 00766           CALL    SETPAR
   046.250  076 001     00767           MVI     A,1
   046.252  062 061 041 00768           STA     AIO.UNI
   046.255  361         00769           POP     PSW
   046.256  315 270 042 00770           CALL    CHROUT
   046.261  303 017 045 00771           JMP     BEGLP
                        00772   * COMMAND SET DS 80 TRACK
   046.264              00773   SET2S8  EQU     *
   046.264  365         00774           PUSH    PSW
   046.265  315 136 031 00775           CALL    $TYPTX










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   11

   046.270  123 105 124 00776           DB      'SET DS 80 TRACK',8AH
   046.310  001 120 002 00777           LXI     B,0250H
   046.313  315 073 046 00778           CALL    SETPAR
   046.316  076 001     00779           MVI     A,1
   046.320  062 061 041 00780           STA     AIO.UNI
   046.323  361         00781           POP     PSW
   046.324  315 270 042 00782           CALL    CHROUT
   046.327  303 017 045 00783           JMP     BEGLP
                        00784   * COMMAND QUERY DISK TYPE
   046.332              00785   QUERY   EQU     *
   046.332  315 270 042 00786           CALL    CHROUT
   046.335  315 136 031 00787           CALL    $TYPTX
   046.340  121 125 105 00788           DB      'QUERY DISK TYPE',8AH
   046.360  315 067 047 00789           CALL    QUERY1
   046.363  072 043 050 00790           LDA     SPERT           SECTORS PER TRACK
   046.366  315 270 042 00791           CALL    CHROUT
                        00792   * READ ADDRESS RESULTS
   046.371  072 050 050 00793           LDA     SECBUF          TRACK
   046.374  315 270 042 00794           CALL    CHROUT
   046.377  072 051 050 00795           LDA     SECBUF+1        SIDE
   047.002  315 270 042 00796           CALL    CHROUT
   047.005  072 052 050 00797           LDA     SECBUF+2        SECTOR
   047.010  315 270 042 00798           CALL    CHROUT
   047.013  072 053 050 00799           LDA     SECBUF+3        SECTOR LENGTH
   047.016  315 270 042 00800           CALL    CHROUT
   047.021  072 054 050 00801           LDA     SECBUF+4        CRC 1
   047.024  315 270 042 00802           CALL    CHROUT
   047.027  072 055 050 00803           LDA     SECBUF+5        CRC 2
   047.032  315 270 042 00804           CALL    CHROUT
                        00805   * DISK PARAMETERS
   047.035  072 047 050 00806           LDA     NUMSID          NUM SIDES
   047.040  315 270 042 00807           CALL    CHROUT
   047.043  052 044 050 00808           LHLD    RDCNT
   047.046  175         00809           MOV     A,L             RDCNT LOW BYTE
   047.047  315 270 042 00810           CALL    CHROUT
   047.052  174         00811           MOV     A,H             RDCNT HIGH BYTE
   047.053  315 270 042 00812           CALL    CHROUT
   047.056  072 042 050 00813           LDA     DENS            DENSITY CON.MFM OR 0
   047.061  315 270 042 00814           CALL    CHROUT
   047.064  303 017 045 00815           JMP     BEGLP
                        00816   *
   047.067              00817   QUERY1  EQU     *
   047.067  257         00818           XRA     A
   047.070  062 043 050 00819           STA     SPERT
   047.073  076 004     00820           MVI     A,CON.MFM       TEST MFM FIRST
   047.075  062 042 050 00821           STA     DENS
   047.100  315 043 043 00822           CALL    SELDRV
   047.103              00823   QUERYL  EQU     *
   047.103  076 002     00824           MVI     A,2
   047.105  062 047 050 00825           STA     NUMSID          DOUBLE SIDED DEFAULT
   047.110  075         00826           DCR     A
   047.111  062 040 050 00827           STA     SIDE
   047.114  001 000 001 00828           LXI     B,0100H
   047.117  315 124 044 00829           CALL    READS           TEST READ SIDE 2
   047.122  365         00830           PUSH    PSW
   047.123  257         00831           XRA     A
   047.124  062 040 050 00832           STA     SIDE










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   12

   047.127  361         00833           POP     PSW
   047.130  322 222 047 00834           JNC     QUERYS          GOOD DOUBLE SIDE READ
   047.133  076 001     00835           MVI     A,1
   047.135  062 047 050 00836           STA     NUMSID          SINGLE SIDED DISK
   047.140  001 000 001 00837           LXI     B,0100H
   047.143  315 124 044 00838           CALL    READS           READ A TRACK FILL SPERT+RDCNT
   047.146  322 222 047 00839           JNC     QUERYS          GOOD SINGLE SIDE READ
   047.151  072 042 050 00840           LDA     DENS
   047.154  376 004     00841           CPI     CON.MFM
   047.156  302 267 047 00842           JNZ     QUERY3          FAILED MFM AND FM
   047.161  315 136 031 00843           CALL    $TYPTX
   047.164  103 110 105 00844           DB      'CHECKING SINGLE DENSITY',8AH
   047.214  315 124 043 00845           CALL    CHGDENS         MIGHT BE FM
   047.217  303 103 047 00846           JMP     QUERYL
   047.222              00847   QUERYS  EQU     *
   047.222  315 353 042 00848           CALL    H37CMD
   047.225  041 267 047 00849           LXI     H,QUERY3
   047.230  042 067 040 00850           SHLD    BLKICW
   047.233  072 041 050 00851           LDA     CONCMD
   047.236  366 002     00852           ORI     CON.DRQ
   047.240  323 170     00853           OUT     DK.CON
   047.242  001 000 000 00854           LXI     B,0
   047.245  021 050 050 00855           LXI     D,SECBUF
   047.250  041 260 047 00856           LXI     H,QUERY2
   047.253  257         00857           XRA     A
   047.254  366 304     00858           ORI     FDC.RDA+FDF.DLF
   047.256  323 172     00859           OUT     FD.CMD
   047.260              00860   QUERY2  EQU     *               LOOP UNTIL IRQ4
   047.260  166         00861           HLT                     WAIT FOR DRQ
   047.261  333 173     00862           IN      FD.DAT
   047.263  022         00863           STAX    D
   047.264  023         00864           INX     D
   047.265  003         00865           INX     B
   047.266  351         00866           PCHL
   047.267              00867   QUERY3  EQU     *
   047.267  365         00868           PUSH    PSW
   047.270  076 320     00869           MVI     A,FDC.FI
   047.272  323 172     00870           OUT     FD.CMD
   047.274  333 173     00871           IN      FD.DAT
   047.276  076 010     00872           MVI     A,CON.MO
   047.300  323 170     00873           OUT     DK.CON
   047.302  361         00874           POP     PSW
   047.303  311         00875           RET
                        00876   * SET 9600 BAUD
   047.304              00877   B9600   EQU     *
   047.304  315 136 031 00878           CALL    $TYPTX
   047.307  123 105 124 00879           DB      'SET 9600 BAUD',8AH
   047.325  076 014     00880           MVI     A,0CH
   047.327  062 014 000 00881           STA     BAUDIV
   047.332  315 236 042 00882           CALL    SINT
   047.335  303 017 045 00883           JMP     BEGLP
                        00884   * SET 19200 BAUD
   047.340              00885   B19200  EQU     *
   047.340  315 136 031 00886           CALL    $TYPTX
   047.343  123 105 124 00887           DB      'SET 19200 BAUD',8AH
   047.362  076 006     00888           MVI     A,06H
   047.364  062 014 000 00889           STA     BAUDIV










                                                        HEATH ASM #104.06.00
                                                        01-Jan-77  Page   13

   047.367  315 236 042 00890           CALL    SINT
   047.372  303 017 045 00891           JMP     BEGLP
                        00892   *
   047.375              00893   QUIT    EQU     *
   047.375  315 136 031 00894           CALL    $TYPTX
   050.000  012 107 117 00895           DB      0AH,'GOODBYE',8AH
   050.011  315 137 043 00896           CALL    DSLDRV
   050.014  257         00897           XRA     A
   050.015  377 000     00898           SCALL   .EXIT
                        00899   *
   050.017  123 131 060 00900   DEV1    DB      'SY0:',0
   050.024  123 131 061 00901   DEV2    DB      'SY1:',0
   050.031  123 131 062 00902   DEV3    DB      'SY2:',0
                        00903   *
   050.036  000         00904   CURTRK  DB      0               0-79
   050.037  000         00905   CURSEC  DB      0               1-16
   050.040  000         00906   SIDE    DB      0               0 OR 1
   050.041  000         00907   CONCMD  DB      0               LAST COMMAND SENT TO DK.CON
   050.042  004         00908   DENS    DB      CON.MFM
                        00909   *
   050.043  000         00910   SPERT   DB      0               SECTORS PER TRACK
   050.044  000 000     00911   RDCNT   DW      0               BYTES READ
   050.046  000         00912   NUMTRK  DB      0               NUM TRACKS (40 OR 80)
   050.047  000         00913   NUMSID  DB      0               NUM SIDES (1 OR 2)
                        00914   *
                        00915   * HEATH 5.25
                        00916   * FM =10 SECTORS, 256 BYTES (2560 BYTES PER TRACK)
                        00917   * MFM=16 SECTORS, 256 BYTES (4096 BYTES PER TRACK)
                        00918   * PC 5.25
                        00919   * MFM= 8 SECTORS,1024 BYTES (8192 BYTES PER TRACK)
                        00920   *
   050.050              00921   SECBUF  DS      8192            MAX FULL TRACK
                        00922   *
   110.050  000         00923           END     START


00923 Statements Assembled
38216 Bytes Free
 No Errors Detected










